name: PR Quality Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.9"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  FORCE_COLOR: "1"

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determinar SHAs do PR e arquivos modificados
        id: diff
        shell: bash
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "BASE_SHA=$BASE_SHA" >> $GITHUB_ENV
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV

          git diff --name-only "$BASE_SHA...$HEAD_SHA" > changed_files.txt || true
          echo "Arquivos modificados no PR:"
          cat changed_files.txt || true

          PY_CHANGED="$(grep -E '\.py$' changed_files.txt || true)"
          {
            echo "py_changed<<EOF"
            echo "$PY_CHANGED"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements.txt
            **/requirements.txt

      - name: Instalar depend√™ncias (app + ferramentas)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt n√£o encontrado ‚Äì seguindo apenas com ferramentas."
          fi
          pip install flake8 black pytest pytest-cov pip-audit

      - name: Lint apenas arquivos Python modificados (flake8)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s changed_files.txt ]; then
            mapfile -t PYFILES < <(grep -E '\.py$' changed_files.txt || true)
            if [ "${#PYFILES[@]}" -gt 0 ]; then
              echo "Executando flake8 em: ${PYFILES[*]}"
              flake8 "${PYFILES[@]}" --count --select=E9,F63,F7,F82 --show-source --statistics
            else
              echo "Nenhum arquivo Python modificado."
            fi
          else
            echo "Lista de arquivos modificados vazia."
          fi

      - name: Verificar formata√ß√£o dos arquivos modificados (black --check)
        shell: bash
        run: |
          set -euo pipefail
          if [ -s changed_files.txt ]; then
            mapfile -t PYFILES < <(grep -E '\.py$' changed_files.txt || true)
            if [ "${#PYFILES[@]}" -gt 0 ]; then
              echo "Verificando formata√ß√£o em: ${PYFILES[*]}"
              black --check --diff "${PYFILES[@]}"
            else
              echo "Nenhum arquivo Python para verificar formata√ß√£o."
            fi
          else
            echo "Lista de arquivos modificados vazia."
          fi

      - name: Executar testes r√°pidos (se arquivo existir)
        shell: bash
        run: |
          set -euo pipefail
          if [ -f tests/test_integration_api.py ]; then
            pytest tests/test_integration_api.py -v --tb=short
          else
            echo "Arquivo tests/test_integration_api.py n√£o encontrado ‚Äì pulando testes r√°pidos."
          fi

      - name: Verificar se pode fazer build / import
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import sys, importlib
          sys.path.insert(0, 'src')
          try:
              importlib.import_module('backend.integration_api')
              print('‚úÖ Import da API principal: OK')
          except Exception as e:
              print(f'‚ùå Erro no import: {e}')
              raise
          PY

      - name: Comentar no PR com resultado
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number });
            for (const c of comments) {
              if (c.user?.type === 'Bot' && c.body?.includes('<!-- PR_QUALITY_CHECK_MARK -->')) {
                await github.rest.issues.deleteComment({ owner, repo, comment_id: c.id });
              }
            }

            const success = '${{ job.status }}' === 'success';
            const status = success ? '‚úÖ PASSOU' : '‚ùå FALHOU';
            const emoji = success ? 'üéâ' : '‚ö†Ô∏è';

            const body = `<!-- PR_QUALITY_CHECK_MARK -->
            ## ü§ñ PR Quality Check ${status}

            ${emoji} **Status:** ${status}  
            **Commit:** \`${{ github.sha }}\`  
            **Workflow:** [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Verifica√ß√µes Realizadas
            - ${success ? '‚úÖ' : '‚ùå'} Lint (flake8) nos arquivos modificados  
            - ${success ? '‚úÖ' : '‚ùå'} Formata√ß√£o (black) nos arquivos modificados  
            - ${success ? '‚úÖ' : '‚ùå'} Teste r√°pido (test_integration_api.py)  
            - ${success ? '‚úÖ' : '‚ùå'} Verifica√ß√£o de imports

            ${success ? 'üöÄ **Este PR est√° pronto para revis√£o!**' : 'üîß **Este PR precisa de corre√ß√µes antes da revis√£o.**'}
            `;
            await github.rest.issues.createComment({ owner, repo, issue_number, body });

  diff-analysis:
    name: Diff Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analisar mudan√ßas cr√≠ticas
        id: analyze
        shell: bash
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail
          echo "## üìä An√°lise de Mudan√ßas no PR" > diff-analysis.md
          echo >> diff-analysis.md

          CRITICAL_FILES="src/backend/integration_api.py Dockerfile docker-compose.yml requirements.txt"

          for file in $CRITICAL_FILES; do
            if git diff --name-only "$BASE_SHA...$HEAD_SHA" | grep -q "^$file$"; then
              {
                echo "‚ö†Ô∏è **Arquivo cr√≠tico modificado:** \`$file\`"
                echo
                echo '```diff'
                git diff "$BASE_SHA...$HEAD_SHA" -- "$file" | head -50 || true
                echo '```'
                echo
              } >> diff-analysis.md
            fi
          done

          {
            echo "### üìà Estat√≠sticas:"
            echo '```'
            git diff --stat "$BASE_SHA...$HEAD_SHA" || true
            echo '```'
          } >> diff-analysis.md

          cat diff-analysis.md
          {
            echo "### Resumo"
            cat diff-analysis.md
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload an√°lise como artifact
        uses: actions/upload-artifact@v4
        with:
          name: diff-analysis
          path: diff-analysis.md

  security-check-pr:
    name: Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Instalar ferramentas de seguran√ßa
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install bandit pip-audit

      - name: Verificar seguran√ßa com bandit (gera SARIF)
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          TARGET="src"
          [ -d "$TARGET" ] || TARGET="."
          bandit -r "$TARGET" -q -f sarif -o bandit.sarif || true

          echo "## üîí Relat√≥rio de Seguran√ßa (Bandit)" > security-report.md
          bandit -r "$TARGET" -q -f json -o bandit.json || true
          python - <<'PY' >> security-report.md
          import json
          try:
              data = json.load(open('bandit.json'))
              results = data.get('results', [])
              print(f"**Issues encontrados:** {len(results)}\n")
              for issue in results[:5]:
                  print(f"- **{issue.get('test_name','?')}** em `{issue.get('filename','?')}:{issue.get('line_number','?')}`")
                  print(f"  Severidade: {issue.get('issue_severity','?')} | Confian√ßa: {issue.get('issue_confidence','?')}\n")
          except Exception as e:
              print(f"Falha ao processar bandit.json: {e}")
          PY

          echo "### Bandit (resumo)" >> "$GITHUB_STEP_SUMMARY"
          cat security-report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Subir SARIF do Bandit para Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit.sarif

      - name: Verificar depend√™ncias com pip-audit
        shell: bash
        continue-on-error: true
        run: |
          set -euo pipefail
          if [ -f requirements.txt ]; then
            pip-audit -r requirements.txt -f json -o pip-audit.json || true
            echo >> security-report.md
            echo "## üì¶ Verifica√ß√£o de Depend√™ncias (pip-audit)" >> security-report.md
            python - <<'PY' >> security-report.md
            import json
            try:
                data = json.load(open('pip-audit.json'))
                vulns = data if isinstance(data, list) else data.get('vulnerabilities', [])
                print(f"**Vulnerabilidades encontradas:** {len(vulns)}\n")
                for v in vulns[:3]:
                    dep = v.get('dependency', {})
                    pkg = dep.get('name', '?')
                    ver = dep.get('version', '?')
                    advs = v.get('vulns', [])
                    if advs:
                        print(f"- **{pkg}** {ver}")
                        d = advs[0].get('description', '')
                        print(f"  {advs[0].get('id','CVE')} ‚Äî {d[:180]}{'...' if len(d)>180 else ''}\n")
            except Exception as e:
                print(f"Falha ao processar pip-audit.json: {e}")
            PY
          else
            echo "requirements.txt n√£o encontrado ‚Äì pulando pip-audit." >> security-report.md
          fi

          cat security-report.md

      - name: Upload relat√≥rio de seguran√ßa
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report-pr
          path: |
            security-report.md
            bandit.json
            bandit.sarif
            pip-audit.json