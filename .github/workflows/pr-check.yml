# Workflow espec√≠fico para Pull Requests
name: PR Quality Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  PYTHON_VERSION: '3.9'

jobs:
  # Verifica√ß√£o r√°pida para PRs
  pr-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-pr-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-pr-
          ${{ runner.os }}-pip-
    
    - name: Instalar depend√™ncias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pytest pytest-cov
    
    - name: Verificar arquivos modificados
      run: |
        echo "Arquivos modificados no PR:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD
        
        echo "Arquivos Python modificados:"
        git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.py$" || echo "Nenhum arquivo Python modificado"
    
    - name: Lint apenas arquivos modificados
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.py$" | tr '\n' ' ')
        if [ -n "$CHANGED_FILES" ]; then
          echo "Executando flake8 em: $CHANGED_FILES"
          flake8 $CHANGED_FILES --count --select=E9,F63,F7,F82 --show-source --statistics
        else
          echo "Nenhum arquivo Python para verificar"
        fi
    
    - name: Verificar formata√ß√£o dos arquivos modificados
      run: |
        CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.py$" | tr '\n' ' ')
        if [ -n "$CHANGED_FILES" ]; then
          echo "Verificando formata√ß√£o em: $CHANGED_FILES"
          black --check --diff $CHANGED_FILES
        else
          echo "Nenhum arquivo Python para verificar formata√ß√£o"
        fi
    
    - name: Executar testes r√°pidos
      run: |
        pytest tests/test_integration_api.py -v --tb=short
    
    - name: Verificar se pode fazer build
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        try:
            from backend.integration_api import VisionMotoIntegrationAPI
            print('‚úÖ Import da API principal: OK')
        except Exception as e:
            print(f'‚ùå Erro no import: {e}')
            sys.exit(1)
        "
    
    - name: Comentar no PR com resultado
      uses: actions/github-script@v6
      if: always()
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          // Remove coment√°rios anteriores do bot
          for (const comment of comments) {
            if (comment.user.type === 'Bot' && comment.body.includes('ü§ñ PR Quality Check')) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: comment.id,
              });
            }
          }
          
          const success = '${{ job.status }}' === 'success';
          const status = success ? '‚úÖ PASSOU' : '‚ùå FALHOU';
          const emoji = success ? 'üéâ' : '‚ö†Ô∏è';
          
          const body = `## ü§ñ PR Quality Check ${status}
          
${emoji} **Status:** ${status}
**Commit:** \`${{ github.sha }}\`
**Workflow:** [Ver detalhes](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

### Verifica√ß√µes Realizadas:
- ${success ? '‚úÖ' : '‚ùå'} Lint (flake8) nos arquivos modificados
- ${success ? '‚úÖ' : '‚ùå'} Formata√ß√£o (black) nos arquivos modificados  
- ${success ? '‚úÖ' : '‚ùå'} Testes unit√°rios b√°sicos
- ${success ? '‚úÖ' : '‚ùå'} Verifica√ß√£o de imports

${success ? 
'üöÄ **Este PR est√° pronto para revis√£o!**' : 
'üîß **Este PR precisa de corre√ß√µes antes da revis√£o.**'}
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: body
          });

  # An√°lise de diff para mudan√ßas cr√≠ticas
  diff-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Analisar mudan√ßas cr√≠ticas
      run: |
        echo "## üìä An√°lise de Mudan√ßas no PR" > diff-analysis.md
        echo "" >> diff-analysis.md
        
        # Verifica mudan√ßas em arquivos cr√≠ticos
        CRITICAL_FILES="src/backend/integration_api.py Dockerfile docker-compose.yml requirements.txt"
        
        for file in $CRITICAL_FILES; do
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "$file"; then
            echo "‚ö†Ô∏è **Arquivo cr√≠tico modificado:** \`$file\`" >> diff-analysis.md
            echo "" >> diff-analysis.md
            echo "\`\`\`diff" >> diff-analysis.md
            git diff origin/${{ github.base_ref }}...HEAD -- "$file" | head -50 >> diff-analysis.md
            echo "\`\`\`" >> diff-analysis.md
            echo "" >> diff-analysis.md
          fi
        done
        
        # Conta linhas adicionadas/removidas
        STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD)
        echo "### üìà Estat√≠sticas:" >> diff-analysis.md
        echo "\`\`\`" >> diff-analysis.md
        echo "$STATS" >> diff-analysis.md
        echo "\`\`\`" >> diff-analysis.md
        
        cat diff-analysis.md
    
    - name: Upload an√°lise como artifact
      uses: actions/upload-artifact@v4
      with:
        name: diff-analysis
        path: diff-analysis.md

  # Verifica√ß√£o de seguran√ßa para PRs
  security-check-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Instalar ferramentas de seguran√ßa
      run: |
        pip install bandit safety
    
    - name: Verificar seguran√ßa com bandit
      run: |
        bandit -r src/ -f json -o bandit-pr-report.json || true
        
        if [ -f bandit-pr-report.json ]; then
          echo "## üîí Relat√≥rio de Seguran√ßa (Bandit)" > security-report.md
          echo "" >> security-report.md
          
          ISSUES=$(cat bandit-pr-report.json | python -c "
import json, sys
data = json.load(sys.stdin)
print(f'**Issues encontrados:** {len(data.get(\"results\", []))}')
for issue in data.get('results', [])[:5]:  # Mostra apenas os 5 primeiros
    print(f'- **{issue[\"test_name\"]}** em \`{issue[\"filename\"]}:{issue[\"line_number\"]}\`')
    print(f'  Severidade: {issue[\"issue_severity\"]} | Confian√ßa: {issue[\"issue_confidence\"]}')
    print()
          ")
          
          echo "$ISSUES" >> security-report.md
          cat security-report.md
        fi
      continue-on-error: true
    
    - name: Verificar depend√™ncias com safety
      run: |
        safety check --json --output safety-pr-report.json || true
        
        if [ -f safety-pr-report.json ]; then
          echo "## üì¶ Verifica√ß√£o de Depend√™ncias (Safety)" >> security-report.md
          echo "" >> security-report.md
          
          VULNS=$(cat safety-pr-report.json | python -c "
import json, sys
try:
    data = json.load(sys.stdin)
    vulns = data.get('vulnerabilities', [])
    print(f'**Vulnerabilidades encontradas:** {len(vulns)}')
    for vuln in vulns[:3]:  # Mostra apenas as 3 primeiras
        print(f'- **{vuln[\"package_name\"]}** {vuln[\"analyzed_version\"]}')
        print(f'  {vuln[\"advisory\"]}')
        print()
except:
    print('Nenhuma vulnerabilidade encontrada')
          ")
          
          echo "$VULNS" >> security-report.md
        fi
      continue-on-error: true
    
    - name: Upload relat√≥rio de seguran√ßa
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report-pr
        path: |
          security-report.md
          bandit-pr-report.json
          safety-pr-report.json
